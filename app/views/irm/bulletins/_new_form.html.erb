<%= common_title(@bulletin.class.name,"",@bulletin.title) %>

<script type="text/javascript" src="/javascripts/ext4-all.js"></script>
<link rel="stylesheet" type="text/css" href="/themes/salesforce2/stylesheets/ext4-all.css"></link>

<%= form_for(@bulletin,:url=>{:controller =>"irm/bulletins", :action=>"create"},:builder => LabellingFormBuilder, :html => {:multipart => true}) do |f| %>
<%= hidden_field_tag :return_url,@return_url %>
<%= f.hidden_field :column_ids %>
<div id="ep" class="bEditBlock bPageBlock">
  <div class="pbHeader">
    <table cellpadding="0" cellspacing="0" border="0">
      <tbody>
        <tr>
          <td class="pbTitle"><h2 class="mainTitle"><%=t(:label_irm_bulletin_new)%></h2></td>
          <td id="topButtonRow" class="pbButton">
            <div class="button"><%= f.submit t(:save), :id => "new_bulletin_submit_top"%></div>
            <% if @return_url%>
              <div class="button"><%= link_to t(:cancel), @return_url%></div>
            <% else %>
              <div class="button"><%= link_to t(:cancel), {:controller => "irm/home",:action=>"index"}%></div>
            <% end %>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
  <div class="pbBody">
    <%= error_for @bulletin%>
    <%= flash_notice %>
    <div id="head_1_ep" class="pbSubheader first tertiaryPalette">
      <span class="pbSubExtra">
        <span class="requiredLegend">
          <span class="requiredExampleOuter">
            <span class="requiredExample">&nbsp;</span>
          </span><span class="requiredMark">*</span>
          <span class="requiredText"> = <%=t(:label_is_required)%></span>
        </span>
      </span>
      <h3><%= t(:label_common_info) %></h3>
    </div>
    <div class="pbSubsection">
      <table class="detailList" cellpadding="0" cellspacing="0" border="0">
        <tbody>
            <tr>
              <td class="labelCol"><label><%=(t :label_irm_bulletin_title)%></label></td>
              <td class="data2Col"><%=f.text_field :title, :required=>true,:style => "width:80%;min-with:200px;"%></td>
            </tr>

            <tr>
              <td class="labelCol"><label><%=(t :label_irm_bulletin_content)%></label></td>
              <td class="data2Col" colspan="4" width="100%">
                <%= f.text_area :content ,:id=>"msgEditor",:value=>"  ",:style=>"display:none;"%>
              </td>
            </tr>
            <tr>
              <td class="labelCol"><label><%=(t :label_irm_bulletin_sticky_flag)%></label></td>
              <td class="data2Col"><%=f.check_box :sticky_flag%></td>
            </tr>
        </tbody>
      </table>
    </div>
  </div>

  <div class="pbBody">
    <div class="pbSubheader first tertiaryPalette">
      <h3><%= t(:label_irm_bu_column) %></h3>
    </div>
    <div class="pbSubsection">
      <table class="detailList" cellpadding="0" cellspacing="0" border="0">
        <tbody>
            <tr>
              <td class="labelCol"><label><%=(t :label_irm_bu_column_choice)%></label></td>
              <td class="data2Col"><div id="tree-div" href="<%= url_for(:controller => "irm/bu_columns", :action=>"get_columns_data", :format=>:json) %>"></div></td>
            </tr>
        </tbody>
      </table>
    </div>
  </div>

  <div class="pbBody">
    <div class="pbSubheader first tertiaryPalette">
      <h3><%= t(:label_irm_bulletin_access) %><span style="font-weight:normal;font-size:12px;">&nbsp;-&nbsp;<%=  t(:label_irm_bulletin_if_access_list_none)  %></span></h3>
    </div>
    <div class="pbSubsection">
      <table class="detailList" cellpadding="0" cellspacing="0" border="0">
        <tbody>
            <tr>
              <td class="labelCol empty">&nbsp;</td>
              <td class="dataCol empty">&nbsp;</td>
              <td class="labelCol empty">&nbsp;</td>
              <td class="dataCol empty">&nbsp;</td>
            </tr>

            <%= render :partial => "irm/duel_select/search",:locals => {:label=>t(:label_irm_wf_rule_action_type),:f=>f,:types=>duel_types,:sources=>duel_values,:str_value_field=>:access_str,:str_value=>""} %>

        </tbody>
      </table>
    </div>
  </div>

  <div class="pbBody">
    <div class="pbSubheader first tertiaryPalette">
      <h3><%= t(:label_irm_bulletin_attachment) %></h3>
    </div>
    <div class="pbSubsection">
      <table cellpadding="0" cellspacing="0" border="0">
        <thead>
          <tr>
            <th width="5%"></th>
            <th width="40px"></th>
            <th><%= t :label_skm_file_name %></th>
            <th><%= t :label_skm_file_category %></th>
            <th><%= t :description%></th>
          </tr>
        </thead>
        <tbody id="file_body">
            <tr id="file_0">
              <td class="dataCol"></td>
              <td class="dataCol"><%= link_to t(:delete), {}, {:href => "javascript:void(0);", :onclick => "delete_line(0);"} %></td>
              <td class="dataCol"><%=file_field_tag "file[0][file]"%></td>
              <td class="dataCol"><%=select_tag "file[0][file_category]", options_for_select(available_file_categories)%></td>
              <td class="dataCol"><%=text_field_tag "file[0][description]", "", {:rows => 3, :cols => 35}%>(<%= t(:file_upload_limit_alert, :m => Irm::SystemParametersManager.upload_file_limit) %>)</td>
            </tr>
            <tr id="file_1">
              <td class="dataCol"></td>
              <td class="dataCol"><%= link_to t(:delete), {}, {:href => "javascript:void(0);", :onclick => "delete_line(1);"} %></td>
              <td class="dataCol"><%=file_field_tag "file[1][file]"%></td>
              <td class="dataCol"><%=select_tag "file[1][file_category]", options_for_select(available_file_categories)%></td>
              <td class="dataCol"><%=text_field_tag "file[1][description]", "", {:rows => 3, :cols => 35}%>(<%= t(:file_upload_limit_alert, :m => Irm::SystemParametersManager.upload_file_limit) %>)</td>
            </tr>
            <tr id="file_2">
              <td class="dataCol"></td>
              <td class="dataCol"><%= link_to t(:delete), {}, {:href => "javascript:void(0);", :onclick => "delete_line(2);"} %></td>
              <td class="dataCol"><%=file_field_tag "file[2][file]"%></td>
              <td class="dataCol"><%=select_tag "file[2][file_category]", options_for_select(available_file_categories)%></td>
              <td class="dataCol"><%=text_field_tag "file[2][description]", "", {:rows => 3, :cols => 35}%>(<%= t(:file_upload_limit_alert, :m => Irm::SystemParametersManager.upload_file_limit) %>)</td>
            </tr>
            <tr id="file_3">
              <td class="dataCol"></td>
              <td class="dataCol"><%= link_to t(:delete), {}, {:href => "javascript:void(0);", :onclick => "delete_line(3);"} %></td>
              <td class="dataCol"><%=file_field_tag "file[3][file]"%></td>
              <td class="dataCol"><%=select_tag "file[3][file_category]", options_for_select(available_file_categories)%></td>
              <td class="dataCol"><%=text_field_tag "file[3][description]", "", {:rows => 3, :cols => 35}%>(<%= t(:file_upload_limit_alert, :m => Irm::SystemParametersManager.upload_file_limit) %>)</td>
            </tr>
            <tr id="file_4">
              <td class="dataCol"></td>
              <td class="dataCol"><%= link_to t(:delete), {}, {:href => "javascript:void(0);", :onclick => "delete_line(4);"} %></td>
              <td class="dataCol"><%=file_field_tag "file[4][file]"%></td>
              <td class="dataCol"><%=select_tag "file[4][file_category]", options_for_select(available_file_categories)%></td>
              <td class="dataCol"><%=text_field_tag "file[4][description]", "", {:rows => 3, :cols => 35}%>(<%= t(:file_upload_limit_alert, :m => Irm::SystemParametersManager.upload_file_limit) %>)</td>
            </tr>
        </tbody>
        <tbody>
            <tr>
              <td class="dataCol"></td>
              <td class="dataCol"></td>
              <td class="dataCol"><%= link_to t(:label_skm_file_add_line), {}, {:href => "javascript:void(0);", :onclick => "generate_line();"} %></td>
              <td class="dataCol"></td>
              <td class="dataCol"></td>
            </tr>
        </tbody>
      </table>
    </div>
  </div>

  <div class="pbBottomButtons">
    <table cellpadding="0" cellspacing="0" border="0">
      <tbody>
        <tr>
          <td class="pbTitle"></td>
          <td id="bottomButtonRow" class="pbButton">
            <div class="button"><%= f.submit t(:save), :id => "new_bulletin_submit"%></div>
            <% if @return_url %>
              <div class="button"><%= link_to t(:cancel), @return_url%></div>
            <% else %>
              <div class="button"><%= link_to t(:cancel), {:controller => "irm/home",:action=>"index"}%></div>
            <% end %>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</div>
<% end %>

<script type="text/javascript">

GY.use('irm','node','substitute','yui2-editor', function(Y) {
    var YAHOO = Y.YUI2;

    var editor = new YAHOO.widget.Editor('msgEditor', {
        height:'250px',
        width:'80%',
        toolbar: {
            buttons: [
                { group: 'textstyle',
                    buttons: [
                        { type: 'push', label: 'Bold', value: 'bold' },
                        { type: 'push', label: 'Italic', value: 'italic' },
                        { type: 'push', label: 'Underline', value: 'underline' },
                        { type: 'push', label: 'Create an Unordered List', value: 'insertunorderedlist' },
	                    { type: 'push', label: 'Create an Ordered List', value: 'insertorderedlist' },
                        { type: 'push', label: 'Upload Image From Clipboard', value: 'uploadImageFormClipboard', id: 'uploadImageFormClipboard' },
                        { type: 'color', label: 'Font Color', value: 'forecolor', disabled: true },
                        { type: 'color', label: 'Background Color', value: 'backcolor', disabled: true }
                    ]
                }
            ]
        }
    });

    var dialog = new Y.YUI2.widget.Dialog("container_applet_upload", {
        visible: true,
        context: [Y.one("#uploadImageFormClipboard"), "tl", "bl"],
        draggable: true,
        close: true
    });

    editor.on('toolbarLoaded', function() {
        this.toolbar.on('uploadImageFormClipboardClick', function(o) {
              if (Y.one("#container_applet_upload_c")){
                Y.one("#container_applet_upload_c").remove();
              }
              dialog.setBody("<iframe frameborder=0 scrolling='no'  src='/common/upload_screen_shot' class='screen_shot_frame'></iframe>");
              dialog.setHeader('<%= t :upload_from_clipboard%>');
              dialog.render(document.body);
              dialog.center();
              dialog.show();
        });
    }, editor, true);

    editor.render();

    Y.all("#new_bulletin_submit").on("click",function(){
      editor.saveHTML();
    });

    Y.all("#new_bulletin_submit_top").on("click",function(){
      editor.saveHTML();
    });
});
</script>



<script>
Ext.onReady(function() {
    var treeNode = Ext.getDom("tree-div");

    Ext.define('ColumnField', {
        extend: 'Ext.data.Model',
        fields: [
            {name: 'id',type: 'string'},
            {name: 'text',type: 'string'},
            {name: 'sc_id',type: 'string'},
            {name: 'column_name',type: 'string'},
            {name: 'column_description',type: 'string'},
            {name: 'sc_code',type: 'string'}
        ]
    });
    var store = Ext.create('Ext.data.TreeStore', {
        model: "ColumnField",
        proxy: {type: 'ajax',url:  treeNode.getAttribute("href") + "?with_check=<%= @bulletin.column_ids%>"}
    });

    var tree = Ext.create('Ext.tree.Panel', {
        store: store,
        rootVisible: false,
        useArrows: true,
        renderTo: 'tree-div',
        width: 200,
        height: 80,
        listeners:{
            'itemclick':function(view, record, item, index, e){
                var column_ids = [];
                Ext.Array.each(tree.getChecked(), function(rec){
                    column_ids.push(rec.get('id'));
                });
                Ext.getDom("irm_bulletin_column_ids").setAttribute("value", column_ids);
            }
        }
    });

});
</script>

<script type="text/javascript">
  function delete_subject(tar){
    GY.use(function(Y){
        Y.one("#tr_" + tar).remove();
    })
  }

  function add_subject(tar){
    GY.use(function(Y){
        Y.one("#tr_");
    })
  }


  var line_count = 5;

  function save(){
    document.file_form.action = "batch_create";
    file_form.submit();
  }
 function delete_line(l)
 {
      GY.use(function(Y){
          Y.one("#file_" + l).remove();
      })
  }
  function generate_line()
  {
      GY.use(function(Y){
          var node = Y.Node.create('<tr id="file_' + line_count + '">'
                  + '<td class="dataCol"></td>'
                  + '<td class="dataCol"><a onclick="delete_line(' + line_count + ');" href="javascript:void(0);"><%= t :delete%></a></td>'
                  + '<td class="dataCol"><input type="file" required="required" name="file[' + line_count + '][file]" id="file_' + line_count + '_file"></td>'
                  + '<td class="dataCol"><select required="required" name="file[' + line_count + '][file_category]" id="file_' + line_count + '_file_category">' + '<%= options_for_select(available_file_categories).gsub!(/\n+/, "")%>' + '</select></td>'
                  + '<td class="dataCol"><input type="text" value="" rows="3" name="file[' + line_count + '][description]" id="file_' + line_count + '_description" cols="35">(<%= t(:file_upload_limit_alert, :m => Irm::SystemParametersManager.upload_file_limit) %>)</td>'
                  + '</tr>');
          Y.one("#file_body").appendChild(node);
      });
      line_count ++;
  }
</script>