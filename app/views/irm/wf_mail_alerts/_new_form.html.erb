<style type="text/css">
  div.recipient{
      float:left;
  }
  div.recipientLabel{
      padding: 0px 5px 0px 15px;
  }
  div.recipientElement{
      float:left;
      width:24%;
  }
</style>
<%= form_for(@wf_mail_alert,:url=>{:action=>"create"},:builder => LabellingFormBuilder) do |f| %>
  <%= hidden_params_field(:source_str)%>
  <%= back_url_hidden_field_tag%>
<div id="ep" class="edit-block page-block">
  <div class="pbHeader">
    <table cellpadding="0" cellspacing="0" border="0">
      <tbody>
        <tr>
          <td class="pbTitle"><h2 class="mainTitle"><%=t(:label_irm_wf_mail_alert_new)%></h2></td>
          <td id="topButtonRow" class="pbButton">
            <div class="button"><%= f.submit t(:save)%></div>
            <div class="button"><%= link_to t(:save_and_new), {:action => "create",:save_and_new=>"Y"},{:class=>"submit"} %></div>
            <div class="button"><%= link_to t(:cancel),back_url_default({:action=>"index"})%></div>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
  <div class="pbBody">
    <%= error_for @wf_mail_alert %>
    <div id="head_1_ep" class="pbSubheader first tertiaryPalette">
      <span class="pbSubExtra">
        <span class="requiredLegend">
          <span class="requiredExampleOuter">
            <span class="requiredExample">&nbsp;</span>
          </span><span class="requiredMark">*</span>
          <span class="requiredText"> = <%=t(:label_is_required)%></span>
        </span>
      </span>
      <h3><%= t(:label_common_info) %></h3>
    </div>
    <div class="pbSubsection">
      <table class="detailList" cellpadding="0" cellspacing="0" border="0">
        <tbody>
            <tr>
              <td class="labelCol"><label for="wf_mail_alert_name"><%=t(:label_irm_wf_mail_alert_name)%></label></td>
              <td class="dataCol"><%=f.text_field :name, :required=>true ,:size=>60,:id=>"wf_mail_alert_name"%></td>
              <td class="labelCol empty">&nbsp;</td>
              <td class="dataCol empty">&nbsp;</td>
            </tr>
            <tr>
              <td class="labelCol"><label for="wf_mail_alert_mail_alert_code"><%=t(:label_irm_wf_mail_alert_mail_alert_code)%></label></td>
              <td class="dataCol"><%=f.text_field :mail_alert_code, :required=>true ,:irm_uppercase=>true,:id=>"wf_mail_alert_mail_alert_code"%></td>
              <td class="labelCol empty">&nbsp;</td>
              <td class="dataCol empty">&nbsp;</td>
            </tr>
            <% if @wf_mail_alert.bo_code.present? %>
              <tr>
                <td class="labelCol"><label for="bo_code"><%=t(:label_irm_wf_mail_alert_bo_code)%></label></td>
                <td class="dataCol"><%= bo_name(@wf_mail_alert.bo_code)%></td>
                <td class="labelCol empty">&nbsp;<%= f.hidden_field(:bo_code,:id=>"bo_code") %></td>
                <td class="dataCol empty">&nbsp;</td>
              </tr>
            <% else %>
              <tr>
                <td class="labelCol"><label for="bo_code"><%=t(:label_irm_wf_mail_alert_bo_code)%></label></td>
                <td class="dataCol"><%=f.blank_select :bo_code,available_business_object,{}, {:id=>"bo_code",:required=>true,:href=>url_for(:controller=>"irm/object_attributes",:action=>"person_columns",:format=>"json",:business_object_code=>"{bo_code}")}}%></td>
                <td class="labelCol empty">
                </td>
                <td class="dataCol empty">&nbsp;</td>
              </tr>
            <% end %>

            <tr>
              <td class="labelCol"><label for="wf_mail_alert_mail_template_code"><%=t(:label_irm_wf_mail_alert_mail_template_code)%></label></td>
              <td class="dataCol"><%=f.blank_select :mail_template_code,available_mail_template,{}, :required=>true ,:id=>"wf_mail_alert_mail_template_code"%></td>
              <td class="labelCol empty">&nbsp;</td>
              <td class="dataCol empty">&nbsp;</td>
            </tr>
            <tr>
              <td class="labelCol"><label for="wf_mail_alert_mail_template_code"><%=t(:label_irm_wf_mail_recipients)%></label></td>
              <td class="dataCol" colspan="3">
                <%= render :partial => "irm/duel_select/tmpl",:locals => {:f=>f,:types=>bo_person_field_duel_types([Irm::ExternalSystem.name]),:sources=>bo_person_field_duel_values(@wf_mail_alert.bo_code,[Irm::ExternalSystem.name]),:str_value_field=>:recipient_str,:str_value=>@wf_mail_alert.get_recipient_str,:size=>7} %>
              </td>
            </tr>

            <tr>
              <td class="labelCol"><label for="wf_mail_alert_additional_email"><%=t(:label_irm_wf_mail_alert_additional_email)%></label></td>
              <td class="dataCol" colspan="3" width="82%"><%=f.text_area :additional_email,:rows=>4,:cols=>60%></td>
            </tr>
            <tr>
              <td class="labelCol"><label for="wf_mail_alert_from_email"><%=t(:label_irm_wf_mail_alert_from_email)%></label></td>
              <td class="dataCol"><%=f.text_field :from_email, :id=>"wf_mail_alert_from_email"%></td>
              <td class="labelCol empty">&nbsp;</td>
              <td class="dataCol empty">&nbsp;</td>
            </tr>
        </tbody>
      </table>
    </div>
  </div>
  <div class="pbBottomButtons">
    <table cellpadding="0" cellspacing="0" border="0">
      <tbody>
        <tr>
          <td class="pbTitle"></td>
          <td id="bottomButtonRow" class="pbButtonb">
            <div class="button"><%= f.submit t(:save)%></div>
            <div class="button"><%= link_to t(:save_and_new), {:action => "create",:save_and_new=>"Y"},{:class=>"submit"} %></div>
            <div class="button"><%= link_to t(:cancel),back_url_default({:action=>"index"})%></div>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</div>
<% end %>
<script type="text/javascript">
  $(function(){



      if($("select#bo_code"))
      {
          var type = '<%= Irm::BusinessObject.class_name_to_code(Irm::ObjectAttribute.name)%>';
          var type_name = '<%= Irm::BusinessObject.class_name_to_meaning(Irm::ObjectAttribute.name)%>';

          $("select#bo_code").change(function(event){
              var bo = $(this.target);
              var url = decodeURIComponent(bo.attr("href"));
              url = url.replace("{bo_code}",bo.val());

              $.getJSON(url,{},function(datas){
                  var items = [];
                  datas = datas["items"] ;
                  if(!datas)
                    datas = [];
                  $.each(datas,function(index,data){
                      var item = {};
                      item.id = data.id;
                      item.html = type_name+":"+data.label;
                      item.value = type+"#"+data.value;
                      item.query = data.label;
                      item.type = type;
                      items.push(item)
                  });


              });

          });

      }
  });
</script>

