<% require_css(:jpolite) %>
<% require_javascript(:jpolite) %>
<style type="text/css">
  .dragging{
      border: 2px dashed;
      border-color: gray;
      min-height: 80px;
  }
  td.added img{
      visibility: hidden;
  }
  .current_layout {
      margin: 0;
      padding: 0;
  }
  .current_layout .dragging{
      min-height: 20px !important;
  }
  .current_layout .span-12 {
      width: 47.6%;
  }
</style>

<ul id="main_nav" style="display:none;">
   <li id="t1"><b class="hover">homePage</b></li>
</ul>
<div id="jpolite_content"  class="jpolite-container">
    <% 1.upto(pconfig[5]).each do |index| %>
      <div id="c<%=index%>" class="cc"></div>
    <% end %>
</div>

<!-- A default template is required here without an ID -->
<div class="module_template">
	<div class="moduleFrame">
		<div class='moduleHeader'>
			<div class='moduleTitle'></div>
			<div class='moduleActions'>
				<b title="Refresh" class="actionRefresh"></b>
				<b title="Collapse" class="actionMin"></b>
				<b title="Expand" class="actionMax"></b>
				<b title="Close" class="actionClose"></b>
			</div>
		</div>
		<div class='moduleContent'>
		</div>
	</div>
</div>
<!-- portal_layout设置窗口 -->
<div style="display:none;">
    <div id="portalLayouts" style="background-color: transparent; width: 400px; height:auto;padding: 30px 10px 10px 10px;">
      <%= form_tag(:controller => "portlet_configs", :action =>"save_portal_layout", :method => "post") do %>
          <%= hidden_field_tag "portal_layout_id", pconfig[1].id, :id=>"portal_layout_id" %>
          <table style="font-size:12px;width:100%;">
              <tr>
                <td style="width:100px; font-size: 13px; text-align: right; font-weight: bold;"><label for="portalLayoutSelect"><%= t(:label_irm_portlet_select_layout) %></label></td>
                <td class="dataCol"><%= select_for_layouts "portalContainerSelect", available_portal_layouts , pconfig[1].id,{:required=>true,:id=>"portalContainerSelect" } %></td>
              </tr>
              <tr>
                <td colspan="2"><hr></td>
              </tr>
              <tr>
                <td height="auto" colspan="2">
                  <!--  current portal_layout preview -->
                    <div class="current_layout"></div>
                  <!--  end of current portal_layout preview -->
                </td>
              </tr>
              <tr>
                <td colspan="2"><hr></td>
              </tr>
              <tr>
                <td>&nbsp;</td>
                <td>
                  <div class="button"><%= link_submit t(:save)%></div>
                  <div class="button" id="portlalCancleButton"><%= link_to t(:cancel), "javascript:void(0);" %></div>
                </td>
              </tr>
          </table>
      <% end %>
    </div>
</div>
<!-- 结束portal_layout-->

<div style="display:none;">
    <div id="portletList" style="background-color: transparent; width: 300px; height:160px;padding: 30px 10px 10px 10px;">
      <table id="modules" style="font-size:12px;width:100%;">
        <% (0..pconfig[0].length-1).step(3) do |index| %>
          <tr>
            <td>
              <%= check_box_tag 'modules[]', pconfig[0][index].id,false,:class=>"addModule",:ref=> pconfig[0][index].id,:id=>"check#{pconfig[0][index].id}"%>
              <label for="check<%=pconfig[0][index].id%>"><%= pconfig[0][index][:name] %></label>
            </td>
            <td>
              <% if pconfig[0][index+1] %>
                <%= check_box_tag 'modules[]', pconfig[0][index+1].id,false,:class=>"addModule",:ref=> pconfig[0][index+1].id,:id=>"check#{pconfig[0][index+1].id}"%>
                <label for="check<%=pconfig[0][index+1].id%>"><%= pconfig[0][index+1][:name] %></label>
              <% end %>
            </td>
            <td>
              <% if pconfig[0][index+2] %>
                <%= check_box_tag 'modules[]', pconfig[0][index+2].id,false,:class=>"addModule",:ref=> pconfig[0][index+2].id,:id=>"check#{pconfig[0][index+2].id}"%>
                <label for="check<%=pconfig[0][index+2].id%>"><%= pconfig[0][index+2][:name] %></label>
              <% end %>
            </td>
          </tr>
        <% end %>
      </table>

    </div>
</div>

<script>
  var _modules=window["eval"]("(" +'<%=pconfig[2]%>'+ ")");
  var _moduleLayout=window["eval"]("(" +"<%=pconfig[3]%>"+ ")");
  var _columnLayout = window["eval"]("(" +"<%=pconfig[4]%>"+ ")");

  var portal_options = {};
  portal_options.layoutPersistence = [
    function() {
        return window["eval"]("(" + $.cookie('jpolite2layout') + ")")
    },
    function(portal_options) {
        //通过ajax保存配置信息至数据库
        $.ajax({
          type: 'POST',
          url: '/portlet_configs/save_portal_config',
          data: {portal_config: portal_options},
          dataType: 'json',
          success: function(data) { },
          error: function() {}
        });
        //设置portal 配置到cookie
        return $.cookie('jpolite2layout', portal_options);
    }
  ]
  initPortal(portal_options);

  $(function(){
      $("#portalSetting").click(function(e){
          //已经显示在portal中的模块
          var showedModules = $.jpolite.getShowModules();
          $("#portletList input.addModule").each(function(index,module){
              var id = $(module).attr("ref");
              if(showedModules.indexOf("m"+id)>-1){
                  $(module).attr("checked",true);
              }else{
                  $(module).attr("checked",false);
              }
          });
          $.colorbox({inline:true, opacity:0.55, title:"<%= t(:label_irm_portlet_custom_home_page) %>", speed: 0,href:"#portletList"});
      });
      $("#portletList input.addModule").click(function(e){
            console.debug($(e.currentTarget).is(":checked"));
            if($(e.currentTarget).is(":checked")){
                $.jpolite.addModule({
			    	id: "m"+$(e.currentTarget).attr("ref"),
			    	c:	'c1',	//Add to c1 of current tab by default
			    	mc: '',
			    	mt:	''
			    });
            }else{
                $.jpolite.removeModule("m"+$(e.currentTarget).attr("ref"));
            }

      });
      //设置当前的布局
      var current_layout ='<%=pconfig[1].layout%>';
      var current_layout_container = $(".current_layout");
      setLayoutPreview(current_layout, current_layout_container);
      $("#portalChangeLayout").click(function(e){
          //设置portal_layout窗口
          $.colorbox({inline:true, opacity:0.55, title:"<%= t(:label_irm_portlet_change_layout) %>", speed: 0,href:"#portalLayouts"});
      });
      //当选择某一中布局方式的时候
      $("#portalContainerSelect").change(function(){
          if($(this).val()) {
              $("#portal_layout_id").val($(this).val());
              current_layout = $(this).find("option:selected").attr("layout");
              if (typeof current_layout != undefined && current_layout) {
                  setLayoutPreview(current_layout, current_layout_container);
              }else{
                  console.log("ERROR INFO:", "System Data Error!");
              }
          }
      });
      $("#portlalCancleButton").bind("click", function(){
          $.colorbox.close();
      });

      function setLayoutPreview(current_layout, container) {
          container.html("");
          $.each(current_layout.split(','),function(index,value) {
              //生成对应的html标签
              for(i=1; i<=parseInt(value); i++) {
                  if(i == parseInt(value)) {
                     container.append('<div id='+index+' class="dragging cc span-'+(24/parseInt(value))+' last"></div>');
                  }else{
                      container.append('<div id='+index+' class="dragging cc span-'+(24/parseInt(value))+'"></div>');
                  }
              }
          });
      }
  });

</script>