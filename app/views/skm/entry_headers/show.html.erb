<%= app_title %>
<!--页面结构-->
<div class="page-block">
  <table class="page-block-header"><tr>
    <td class="page-block-title">
      <h2 class="block-title">[<%= @entry_header.doc_number%>]&nbsp;&nbsp;&nbsp;<%= @entry_header.entry_title %></h2>
    </td>
    <td class="page-block-button">
      <% if @entry_header[:is_favorite] == Irm::Constant::SYS_NO %>
        <%= link_to t(:save_page), {:controller => "skm/entry_headers", :action => "add_favorites", :id => @entry_header.id, :person_id => Irm::Person.current.id},:class=>"btn btn-primary"%>
      <% end %>
      <% if @entry_header.history_flag == Irm::Constant::SYS_NO %>
        <%= link_to t(:edit), {:action => "edit", :id => @entry_header},:class=>"btn"%>
      <% end %>
      <%= link_to t(:back), {:action => "index"},:class=>"btn cancel"%>
      <!-- 如果知识库没有发布则不能进行新建关联知识库和导出pdf数据 -->
      <%- if @entry_header.entry_status_code.eql?(Skm::EntryStatus::PUBLISHED) -%>
        <%= link_to t(:label_skm_entry_header_new_relation),{:action => "new_relation", :id => @entry_header.id }, :class => "btn btn-primary" %>
        <%= link_to t(:export_pdf), {:controller=>"skm/entry_headers",:action=>"show",:format => "pdf"}, {:class => "btn btn-info",:target => "_blank"} %>
      <%- end -%>
      </td>
  </tr>
  </table>
  <div class="page-block-body">
    <div class="sub-page-block">
      <div class="sub-page-block-header">
        <h3 class="sub-page-block-title"><%= t(:label_skm_navigator) %></h3>
      </div>
      <div class="sub-page-block-body">
        <table class="detail-list">
          <tbody>
          <% @entry_header.entry_details.each do |e| %>
              <tr>
                <td class="data-col"><a href="#<%= e.id %>"><%= e.element_name %></a></td>
              </tr>
          <% end %>
          </tbody>
        </table>
      </div>
    </div>
    <div class="sub-page-block">
      <% @entry_header.entry_details.each do |e| %>
        <div class="sub-page-block-header">
          <h3 class="sub-page-block-title"><%= raw(e.element_name) %></h3>
          <div class="sub-page-block-help" style="float: right;">
            <a href="javascript:void(0);" onclick="scrollTo(0, 0);"><%= t(:go_to_top) %></a>
          </div>
        </div>
        <div class="sub-page-block-body">
          <a id="<%= e.id %>" name="<%= e.id %>">&nbsp;</a>
          <table class="show-table">
            <tbody>
              <tr>
                <td class="data-col" style="padding: 2px 10px !important;">
                  <pre><%= raw(e.entry_content) %></pre>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      <% end %>
    </div>
    <!-- 未发布的知识不能进行表态 -->
    <%- if @entry_header.entry_status_code.eql?(Skm::EntryStatus::PUBLISHED) -%>
      <div class="sub-page-block">
        <div class="sub-page-block-body">
          <div class="digg-zone" id="diggZone">
            <%= show_rating("SKM_RATING",@entry_header) %>
          </div>
        </div>
      </div>
    <%- end -%>
  </div>
</div>
<!-- 未发布的知识没有版本记录 -->
<%- if @entry_header.entry_status_code.eql?(Skm::EntryStatus::PUBLISHED) -%>
  <!-- 版本列表 -->
  <%- content_for :entry_header_histories do -%>
    <div class="page-block">
      <table class="page-block-header">
        <tr>
          <td class="page-block-title">
            <h2 class="block-title"><%= t(:label_skm_entry_header_history_list) %></h2>
          </td>
        </tr>
      </table>
      <div class="page-block-body">
        <%= datatable_view({:count => @entry_history.count, :datas => @entry_history}) do |builder| %>
          <% builder.column(:full_title, {:title => t(:label_skm_entry_header_title)}) do |data| %>
            <%= link_to(data[:full_title], {:controller => "skm/entry_headers", :action => "show", :id => data[:id]}) %>
          <% end %>
          <% builder.column(:published_date, {:title => t(:label_skm_entry_header_published_date), :width => "150px"}) %>
          <% builder.column(:version_number, {:title => t(:label_skm_entry_header_version)}) %>
          <% builder.column(:doc_number, {:title => t(:label_skm_entry_header_doc_number), :width => "120px"}) %>
        <% end %>
      </div>
    </div>
  <%- end -%>
  <%= content_for :entry_header_histories %>
<%- else -%>
  <!-- 显示审核记录 -->
  <div class="page-block">

    <table class="page-block-header">
      <tr>
        <td class="page-block-title">
          <h2 class="block-title"><%= t(:label_skm_entry_header_approval_record) %></h2>
        </td>
        <td class="page-block-button">
          <!-- 有拒绝的审批状态显示重新申请审核 -->
          <%- if has_approval_deny?(@entry_header.id) %>
            <%= form_tag({:controller => "skm/entry_headers",:action => "reset_approve"},:style => "padding:0; margin:0;") do %>
              <%= hidden_field_tag :entry_header_id, @entry_header.id %>
              <%= link_to t(:label_skm_entry_header_approval_reset),'reset_approve', :class => 'btn btn-primary submit' %>
            <%- end -%>
          <%- end %>
        </td>
        <td class="page-block-help form-inline">
          <strong><%= t(:label_skm_entry_header_approval_status_note) %>:</strong>
          <span class="badge badge-success">
            <i class="icon-ok-sign icon-white"></i><%= t(:label_skm_entry_header_approval_status_y) %>
          </span>
          <span class="badge badge-important">
            <i class="icon-remove-sign icon-white"></i><%= t(:label_skm_entry_header_approval_status_r) %>
          </span>
          <span class="badge badge-info">
            <i class="icon-question-sign icon-white"></i><%= t(:label_skm_entry_header_approval_status_n) %>
          </span>
        </td>
      </tr>
    </table>
    <div class="page-block-body">
      <%= datatable_view({:count => @entry_header.entry_approval_people.count, :datas => @entry_header.entry_approval_people}) do |builder| %>
          <% builder.column(:approval_flag, {:title => t(:label_skm_entry_header_approval_status), :width => "60px"}) do |data| %>
            <% if data[:approval_flag].eql?(Irm::Constant::SYS_YES) %>
              <span class="badge badge-success">
                <i class="icon-ok-sign icon-white"></i><%= t(:label_skm_entry_header_approval_status_y) %>
              </span>
            <% elsif data[:approval_flag].eql?(Irm::Constant::SYS_NO) %>
              <span class="badge badge-info">
                <i class="icon-question-sign icon-white"></i><%= t(:label_skm_entry_header_approval_status_n) %>
              </span>
            <% else %>
              <span class="badge badge-important">
                <i class="icon-remove-sign icon-white"></i><%= t(:label_skm_entry_header_approval_status_r) %>
            </span>
            <% end %>
          <% end %>
          <% builder.column(:person_id, {:title => t(:label_skm_entry_header_approval_person), :width => "150px"}) do |data| %>
             <%= Irm::Person.query_person_name(data[:person_id]).first[:person_name] %>
          <% end %>
          <% builder.column(:updated_at, {:title => t(:label_skm_entry_header_approval_date), :width => "150px"}) %>
          <% builder.column(:note, {:title => t(:label_skm_entry_header_approval_note)}) do |data| %>
            <% if data[:approval_flag].eql?(Irm::Constant::SYS_YES) %>
              <span style="color:#468847"><%= data[:note] %></span>
            <% elsif data[:approval_flag].eql?(Irm::Constant::SYS_NO) %>
              <span style="color:#3A87AD"><%= data[:note] %></span>
            <% else %>
              <span style="color: #B94A48"><%= data[:note] %></span>
            <% end %>
          <% end %>
      <% end %>
    </div>
  </div>
<%- end -%>
<!-- 关联的知识库 -->
<div id="entryHeaderRelation">
  <%= render :partial=> "skm/entry_headers/entry_header_relations",:locals=>{:datas=>@entry_relation,:entry_header_id => @entry_header.id }%>
</div>

<%= content_for :sidebar do %>
    <%= render "skm/entry_headers/sidebar_navigate_menu" %>
    <%= render :partial => "/irm/common/recently_objects" %>
<% end -%>