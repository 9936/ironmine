<style type="text/css">
  #statusMatrix{
    padding-left: 20px;
  }
  #statusMatrix th{
    font-weight:bold;
    padding:5px;
  }
  #statusMatrix td{
    font-weight:bold;
    padding:5px;
  }
  #statusMatrix th.to{
    text-align: center;
  }
  #statusMatrix th.from{
    text-align: right;
  }
</style>
<%= common_title(:action_meaning=>t(:label_icm_incident_status_edit_transform)) %>

<%= form_tag({:action=>"update_transform"},:builder => LabellingFormBuilder) do |f| %>
<div id="ep" class="edit-block page-block">
  <div class="pbHeader">
    <table cellpadding="0" cellspacing="0" border="0">
      <tbody>
        <tr>
          <td class="pbTitle"><h2 class="mainTitle"><%=t(:label_icm_incident_status_edit_transform)%></h2></td>
          <td id="topButtonRow" class="pbButton">
          </td>
        </tr>
      </tbody>
    </table>
  </div>
  <div class="pbBody">
    <div id="head_1_ep" class="pbSubheader first tertiaryPalette">
      <span class="pbSubExtra">
        <span class="requiredLegend"><span class="requiredExampleOuter">
          <span class="requiredExample">&nbsp;</span></span>
           <span class="requiredMark">*</span><span class="requiredText"> = <%=t(:label_is_required)%></span></span></span>
      <h3><%=t(:label_icm_incident_status_info)%></h3>
    </div>
    <div class="pbSubsection">
      <table id="statusMatrix" cellpadding="0" cellspacing="0" border="0" error="<%=t(:label_irm_incident_status_transform_event_error) %>">
        <% incident_statuses = available_incident_status;
           incident_status_ids = incident_statuses.collect{|i| i.id};
           events = available_incident_request_event;
           status_transforms = available_status_transform;
        %>
        <tbody>
          <tr>
            <th class="from"></th>
            <% incident_statuses.each do |to_status| %>
              <th class="to"><%= to_status[:name]%></th>
            <% end %>
          </tr>
          <% incident_statuses.each do |from_status| %>
            <tr>
              <th class="from"><%= from_status[:name]%></th>
              <% incident_status_ids.each do |to_id| %>
                <td>
                  <%= blank_select_tag("status_transforms[#{from_status.id}][#{to_id}]",events,(status_transforms[from_status.id]&&status_transforms[from_status.id][to_id]) ? status_transforms[from_status.id][to_id] : nil,{:class=>"eventSelect",:ref=>from_status.id,:include_blank=>"",:title=>from_status[:name]}) %>
                </td>
              <% end %>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  </div>
  <div class="pbBottomButtons">
    <table cellpadding="0" cellspacing="0" border="0">
      <tbody>
        <tr>
          <td class="pbTitle"></td>
          <td id="bottomButtonRow" class="pbButtonb">
            <div class="button"><%= submit_tag t(:save)%></div>
            <div class="button"><%= link_to t(:cancel), {:action => "index"}%></div>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</div>
<% end %>
<script type="text/javascript">
  GY.use(function(Y){
      function getRefValues(ref,value){
        if(!value||value==""){
            return 0;
        }
        var count = 0;
        Y.all("select.eventSelect[ref="+ref+"]").each(function(node){
            if(node.get("value")==value)
              count = count+1;
        });
        return count;
      }
      Y.all("select.eventSelect").on("change",function(e){
        if(getRefValues(e.target.getAttribute("ref"),e.target.get("value"))>1){
          e.target.set("value","");
          alert(Y.one("#statusMatrix").getAttribute("error"));
        }
      })
  });
</script>

