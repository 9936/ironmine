<%= form_tag({:controller => "icm/incident_requests", :action => "add_relation", :source_id => incident_request.id}, :remote => true) do %>
<div class="sidebarModule">
    <div class="sidebarModuleHeader"><h2>
      <%= t :label_icm_incident_request_relation %>
      <% if allow_to_function?(:edit_relation)  %>
      <span style="float:right;"><a style="color:#fff;" href="javascript:void(0);" onclick="show_new_relation_form();"><%= t(:add)%></a></span>
      <% end %>
    </h2></div>
    <div class="sidebarModuleBody">
        <table>

          <tbody id="new_relation_form" style="display:none;">
            <tr>
              <td>
                <div id="relation_select">
                <%= lov_field_tag "icm_relation", Icm::IncidentRequest %>
                </div>
              </td>
            </tr>
            <tr>
              <td>
                <div class="button"><%= submit_tag(t(:save))%>&nbsp;<%= link_to t(:cancel), {}, {:href => "javascript:void(0);", :style => "line-height:21px;", :onclick => "hide_new_relation_form();"} %></div>
              </td>
            </tr>
          </tbody>

            <script type="text/javascript">
            function show_new_relation_form() {
                $("#new_relation_form").css("display", "");
            }

            function hide_new_relation_form() {
                $("#new_relation_form").css("display", "none");
            }
            </script>
          <tbody id="relation_list">
            <%= list_all_icm_incident_relations(incident_request.id)%>
          </tbody>
        </table>

    </div>
</div>
<% end %>

<% unless limit_device? %>
    <script type="text/javascript">
      $(function(){
          $('.request_info').each(function(){
              var qtip = Ext.create('Ext.tip.ToolTip', {
                          target: this,
                          id: 'request-info-tip-' + $(this).attr('request_id'),
                          anchor: 'left',
                          title: "<a href='/incident_requests/" + $(this).attr('request_id') + "/journals/new'>" + $(this).attr('request_name') + "</a>",
                          html: "<iframe frameborder=0 scrolling='no'  src='/incident_requests/" + $(this).attr('request_id') + "/info_card' style='width:100%;height:90px;'></iframe>",
                          width: 400,
                          autoHide: true,
                          dismissDelay: 0,
                          closable: false,
                          listeners: {
                            'afterrender': function(){
                                this.el.on('mouseout', function(e){
                                    if(!qtip.getChildByElement(this)){
                                        qtip.hide();
                                    }
                                });

                                this.el.on('mouseover', function(e){
                                    qtip.suspendEvents();
                                    qtip.show();
                                });

                            }
                          }
                      });
          });
      });
    </script>
<% end %>